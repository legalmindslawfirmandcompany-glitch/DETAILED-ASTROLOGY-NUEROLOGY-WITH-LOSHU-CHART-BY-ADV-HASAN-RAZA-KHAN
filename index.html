import React, { useState, useEffect } from 'react';
import { RefreshCcw, Star, Sun, Moon, Sparkles, User, Users, Clipboard, Volume2, Palette, ChevronDown } from 'lucide-react';

// --- Numerology Mappings and Definitions ---
const MAPPINGS = {
  "Pythagorean": {
    'A': 1, 'J': 1, 'S': 1, 'B': 2, 'K': 2, 'T': 2, 'C': 3, 'L': 3, 'U': 3,
    'D': 4, 'M': 4, 'V': 4, 'E': 5, 'N': 5, 'W': 5, 'F': 6, 'O': 6, 'X': 6,
    'G': 7, 'P': 7, 'Y': 7, 'H': 8, 'Q': 8, 'Z': 8, 'I': 9, 'R': 9
  },
  "Chaldean": {
    'A': 1, 'I': 1, 'J': 1, 'Q': 1, 'Y': 1, 'B': 2, 'K': 2, 'R': 2, 'C': 3, 'G': 3, 'L': 3,
    'S': 3, 'D': 4, 'M': 4, 'T': 4, 'E': 5, 'H': 5, 'N': 5, 'X': 5, 'U': 6, 'V': 6, 'W': 6,
    'O': 7, 'Z': 7, 'F': 8, 'P': 8
  },
  "Cheiro": {
    'A': 1, 'B': 2, 'C': 3, 'D': 4, 'E': 5, 'F': 8, 'G': 3, 'H': 5, 'I': 1, 'J': 1,
    'K': 2, 'L': 3, 'M': 4, 'N': 5, 'O': 7, 'P': 8, 'Q': 1, 'R': 2, 'S': 3,
    'T': 4, 'U': 6, 'V': 6, 'W': 6, 'X': 5, 'Y': 1, 'Z': 7
  },
  "Kabbalistic": {
    'A': 1, 'B': 2, 'C': 3, 'D': 4, 'E': 5, 'F': 6, 'G': 7, 'H': 8, 'I': 9, 'J': 1,
    'K': 2, 'L': 3, 'M': 4, 'N': 5, 'O': 6, 'P': 7, 'Q': 8, 'R': 9, 'S': 1,
    'T': 2, 'U': 3, 'V': 4, 'W': 5, 'X': 6, 'Y': 7, 'Z': 8
  },
  "Islamic (Abjad)": {
    // Abjad mapping for English alphabet based on common transliterations
    'A': 1, 'B': 2, 'C': 20, 'D': 4, 'E': 5, 'F': 80, 'G': 3, 'H': 5, 'I': 10,
    'J': 3, 'K': 20, 'L': 30, 'M': 40, 'N': 50, 'O': 70, 'P': 80, 'Q': 100,
    'R': 200, 'S': 60, 'T': 400, 'U': 6, 'V': 6, 'W': 6, 'X': 10, 'Y': 10, 'Z': 700
  },
  "Tamil (Vedic)": {
    // Simplified Tamil numerology for English alphabet.
    // This is a rough transliteration and not a direct replacement for the Tamil script.
    'A': 1, 'B': 2, 'C': 3, 'D': 4, 'E': 5, 'F': 6, 'G': 7, 'H': 8, 'I': 9, 'J': 1,
    'K': 2, 'L': 3, 'M': 4, 'N': 5, 'O': 6, 'P': 7, 'Q': 8, 'R': 9, 'S': 1,
    'T': 2, 'U': 3, 'V': 4, 'W': 5, 'X': 6, 'Y': 7, 'Z': 8
  },
  "Vowels": ['A', 'E', 'I', 'O', 'U'],
  "Consonants": ['B', 'C', 'D', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'Q', 'R', 'S', 'T', 'V', 'W', 'X', 'Y', 'Z'],
};

const NUMBER_MEANINGS = {
  1: "Individuality, leadership, new beginnings, independence, and pioneering spirit.",
  2: "Balance, partnership, cooperation, diplomacy, and intuition.",
  3: "Creativity, self-expression, communication, and social interaction.",
  4: "Stability, foundation, practicality, hard work, and discipline.",
  5: "Freedom, change, adventure, versatility, and adaptability.",
  6: "Harmony, family, responsibility, nurturing, and service.",
  7: "Spirituality, analysis, inner wisdom, introspection, and perfectionism.",
  8: "Abundance, power, authority, success, and material mastery.",
  9: "Humanitarianism, compassion, completion, and universal love."
};
const MASTER_NUMBERS = new Set([11, 22, 33, 44, 55, 66, 77, 88, 99]);

// --- Astrology Data (Zodiac Basics) ---
const ZODIAC_BASICS = {
  "Aries": { luckyNumber: 9, luckyColor: 'Red', element: 'Fire', birthstone: 'Diamond', planet: 'Mars', luckyDay: 'Tuesday' },
  "Taurus": { luckyNumber: 6, luckyColor: 'Green', element: 'Earth', birthstone: 'Emerald', planet: 'Venus', luckyDay: 'Friday' },
  "Gemini": { luckyNumber: 5, luckyColor: 'Yellow', element: 'Air', birthstone: 'Agate', planet: 'Mercury', luckyDay: 'Wednesday' },
  "Cancer": { luckyNumber: 2, luckyColor: 'White', element: 'Water', birthstone: 'Pearl', planet: 'Moon', luckyDay: 'Monday' },
  "Leo": { luckyNumber: 1, luckyColor: 'Gold', element: 'Fire', birthstone: 'Peridot', planet: 'Sun', luckyDay: 'Sunday' },
  "Virgo": { luckyNumber: 5, luckyColor: 'Gray', element: 'Earth', birthstone: 'Sapphire', planet: 'Mercury', luckyDay: 'Wednesday' },
  "Libra": { luckyNumber: 6, luckyColor: 'Pink', element: 'Air', birthstone: 'Opal', planet: 'Venus', luckyDay: 'Friday' },
  "Scorpio": { luckyNumber: 9, luckyColor: 'Black', element: 'Water', birthstone: 'Topaz', planet: 'Pluto', luckyDay: 'Tuesday' },
  "Sagittarius": { luckyNumber: 3, luckyColor: 'Purple', element: 'Fire', birthstone: 'Turquoise', planet: 'Jupiter', luckyDay: 'Thursday' },
  "Capricorn": { luckyNumber: 8, luckyColor: 'Brown', element: 'Earth', birthstone: 'Garnet', planet: 'Saturn', luckyDay: 'Saturday' },
  "Aquarius": { luckyNumber: 4, luckyColor: 'Blue', element: 'Air', birthstone: 'Amethyst', planet: 'Uranus', luckyDay: 'Saturday' },
  "Pisces": { luckyNumber: 7, luckyColor: 'Sea Green', element: 'Water', birthstone: 'Aquamarine', planet: 'Neptune', luckyDay: 'Thursday' },
};

/**
 * Gets the Zodiac Sign based on the date of birth.
 * @param {string} dob - Date of birth in DD/MM/YYYY or DD-MM-YYYY format.
 * @returns {string|null} The Zodiac sign or null if invalid date.
 */
const getZodiacSign = (dob) => {
  const normalizedDob = dob.replace(/-/g, '/');
  const [day, month] = normalizedDob.split('/').map(Number);
  if (isNaN(day) || isNaN(month) || month < 1 || month > 12) {
    return null;
  }
  
  if ((month === 1 && day >= 20) || (month === 2 && day <= 18)) return "Aquarius";
  if ((month === 2 && day >= 19) || (month === 3 && day <= 20)) return "Pisces";
  if ((month === 3 && day >= 21) || (month === 4 && day <= 19)) return "Aries";
  if ((month === 4 && day >= 20) || (month === 5 && day <= 20)) return "Taurus";
  if ((month === 5 && day >= 21) || (month === 6 && day <= 20)) return "Gemini";
  if ((month === 6 && day >= 21) || (month === 7 && day <= 22)) return "Cancer";
  if ((month === 7 && day >= 23) || (month === 8 && day <= 22)) return "Leo";
  if ((month === 8 && day >= 23) || (month === 9 && day <= 22)) return "Virgo";
  if ((month === 9 && day >= 23) || (month === 10 && day <= 22)) return "Libra";
  if ((month === 10 && day >= 23) || (month === 11 && day <= 21)) return "Scorpio";
  if ((month === 11 && day >= 22) || (month === 12 && day <= 21)) return "Sagittarius";
  if ((month === 12 && day >= 22) || (month === 1 && day <= 19)) return "Capricorn";
  
  return null;
};

/**
 * Generates the basic zodiac details section in Markdown.
 * @param {string} zodiacSign - The person's zodiac sign.
 * @returns {string} The formatted Markdown string.
 */
const generateZodiacBasics = (zodiacSign) => {
  const basics = ZODIAC_BASICS[zodiacSign];
  if (!basics) return '';

  return `### Zodiac Basic Information
---
Your Zodiac Sign is: **${zodiacSign}**
* Lucky Number: **${basics.luckyNumber}**
* Lucky Color: **${basics.luckyColor}**
* Favorable Element: **${basics.element}**
* Birthstone: **${basics.birthstone}**
* Ruling Planet: **${basics.planet}**
* Lucky Day: **${basics.luckyDay}**
`;
};

// --- Numerology Calculation Functions ---
const reduceNumber = (num) => {
  if (MASTER_NUMBERS.has(num)) {
    return num;
  }
  let sum = num;
  while (sum > 9 && !MASTER_NUMBERS.has(sum)) {
    sum = String(sum).split('').reduce((acc, digit) => acc + parseInt(digit, 10), 0);
  }
  return sum;
};

const getDestinyNumber = (name, methodology) => {
  let total = 0;
  const sanitizedName = name.replace(/[^a-zA-Z]/g, '').toUpperCase();
  const detail = `Full Name letters and their values:\n${sanitizedName.split('').map(char => `${char}=${methodology[char] || 0}`).join(' + ')}`;
  total = sanitizedName.split('').reduce((sum, char) => sum + (methodology[char] || 0), 0);
  const finalNumber = reduceNumber(total);
  return { value: finalNumber, detail: `${detail} = ${total}.\nReduction: ${total} -> ${finalNumber}.` };
};

const getSoulUrgeNumber = (name, methodology) => {
  let total = 0;
  const sanitizedName = name.replace(/[^a-zA-Z]/g, '').toUpperCase();
  const vowels = sanitizedName.split('').filter(char => MAPPINGS.Vowels.includes(char));
  const detail = `Vowels and their values:\n${vowels.map(char => `${char}=${methodology[char] || 0}`).join(' + ')}`;
  total = vowels.reduce((sum, char) => sum + (methodology[char] || 0), 0);
  const finalNumber = reduceNumber(total);
  return { value: finalNumber, detail: `${detail} = ${total}.\nReduction: ${total} -> ${finalNumber}.` };
};

const getPersonalityNumber = (name, methodology) => {
  let total = 0;
  const sanitizedName = name.replace(/[^a-zA-Z]/g, '').toUpperCase();
  const consonants = sanitizedName.split('').filter(char => MAPPINGS.Consonants.includes(char));
  const detail = `Consonants and their values:\n${consonants.map(char => `${char}=${methodology[char] || 0}`).join(' + ')}`;
  total = consonants.reduce((sum, char) => sum + (methodology[char] || 0), 0);
  const finalNumber = reduceNumber(total);
  return { value: finalNumber, detail: `${detail} = ${total}.\nReduction: ${total} -> ${finalNumber}.` };
};

const getBirthdayNumber = (dob) => {
  const normalizedDob = dob.replace(/-/g, '/');
  const dobDay = parseInt(normalizedDob.split('/')[0], 10);
  if (isNaN(dobDay)) {
    return { value: 'N/A', detail: 'Invalid Date of Birth format.' };
  }
  const finalNumber = reduceNumber(dobDay);
  const detail = `Day of birth is ${dobDay}.\nReduction: ${dobDay} -> ${finalNumber}`;
  return { value: finalNumber, detail };
};

const getLifePathNumber = (dob) => {
  const normalizedDob = dob.replace(/-/g, '/');
  const [day, month, year] = normalizedDob.split('/').map(Number);
  const reducedYear = reduceNumber(year);
  const reducedMonth = reduceNumber(month);
  const reducedDay = reduceNumber(day);
  const sum = reducedYear + reducedMonth + reducedDay;
  const finalNumber = reduceNumber(sum);
  const detail = `Year (${year}) -> ${reducedYear}\nMonth (${month}) -> ${reducedMonth}\nDay (${day}) -> ${reducedDay}\nSum: ${reducedYear} + ${reducedMonth} + ${reducedDay} = ${sum}.\nReduction: ${sum} -> ${finalNumber}.`;
  return { value: finalNumber, detail };
};

const getLoShuChartNumbers = (dob, name, methodology) => {
  let allDigits = [];
  const dobDigits = dob.replace(/[\/\-]/g, '').split('').filter(d => d !== '0');
  allDigits = allDigits.concat(dobDigits.map(Number));
  if (name && methodology) {
    const sanitizedName = name.replace(/[^a-zA-Z]/g, '').toUpperCase();
    const nameNumbers = sanitizedName.split('').map(char => methodology[char] || 0).filter(n => n > 0);
    allDigits = allDigits.concat(nameNumbers);
  }
  const grid = { '4': 0, '9': 0, '2': 0, '3': 0, '5': 0, '7': 0, '8': 0, '1': 0, '6': 0 };
  allDigits.forEach(num => {
    if (grid.hasOwnProperty(num.toString())) {
      grid[num.toString()] += 1;
    }
  });
  return grid;
};

// --- API Calls and Data Generation ---
const getAstrologyReport = async ({ name, dob, tob, location }) => {
  const prompt = `Act as a professional and expert astrologer. Generate a comprehensive and detailed natal chart analysis for a person. The report should be written in a warm, encouraging, and clear tone.

User's details:
Name: ${name}
Date of Birth: ${dob}
Time of Birth: ${tob || 'Not provided'}
Location of Birth: ${location || 'Not provided'}

The report should include:
- A clear heading with the person's name and birth details.
- A section on the Sun Sign, including its meaning and how it influences personality.
- A section on the Moon Sign, explaining its role in emotions and inner self.
- A section on the Ascendant (Rising) Sign, explaining its influence on outward personality and how others perceive them. (Only if birth time and location are provided).
- A section for each of the other planets (Mercury, Venus, Mars, Jupiter, Saturn, Uranus, Neptune, Pluto), describing their placement by sign and a brief interpretation of their influence.
- A section summarizing the major themes and energies in the chart.
- Use Markdown for formatting, with bold headings and lists for clarity.
- The report should be easy to read and understand for someone with a basic knowledge of astrology.
- Do not make any disclaimers or mention that you are an AI.`;

  const payload = {
    contents: [{ parts: [{ text: prompt }] }],
    model: "gemini-2.5-flash-preview-05-20"
  };
  const apiKey = "";
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

  let retries = 0;
  const maxRetries = 3;
  const baseDelay = 1000;

  const fetchData = async () => {
    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        if (response.status === 429 && retries < maxRetries) {
          const delay = baseDelay * Math.pow(2, retries);
          retries++;
          await new Promise(resolve => setTimeout(resolve, delay));
          return fetchData();
        } else {
          throw new Error(`API call failed with status: ${response.status}`);
        }
      }
      const result = await response.json();
      if (result?.candidates?.[0]?.content?.parts?.[0]?.text) {
        return result.candidates[0].content.parts[0].text;
      } else {
        console.error("Unexpected API response structure:", result);
        throw new Error("Invalid response structure from API.");
      }
    } catch (error) {
      console.error("Error during astrology report generation:", error);
      return `*An error occurred while generating the astrology report. Please try again. Error details: ${error.message}*`;
    }
  };

  return fetchData();
};

const speakTextInThread = async (text, setLoading, setError) => {
  setLoading(true);
  setError(null);
  const payload = {
    contents: [{ parts: [{ text }] }],
    generationConfig: {
      responseModalities: ["AUDIO"],
      speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
    },
    model: "gemini-2.5-flash-preview-tts"
  };
  const apiKey = "";
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

  const base64ToArrayBuffer = (base64) => {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
    return bytes.buffer;
  };

  const pcmToWav = (pcmData, sampleRate) => {
    const numChannels = 1;
    const bytesPerSample = 2;
    const dataLength = pcmData.length * bytesPerSample;
    const buffer = new ArrayBuffer(44 + dataLength);
    const view = new DataView(buffer);
    const writeString = (v, offset, str) => {
      for (let i = 0; i < str.length; i++) { v.setUint8(offset + i, str.charCodeAt(i)); }
    };
    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + dataLength, true);
    writeString(view, 8, 'WAVE');
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, numChannels, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * numChannels * bytesPerSample, true);
    view.setUint16(32, numChannels * bytesPerSample, true);
    view.setUint16(34, bytesPerSample * 8, true);
    writeString(view, 36, 'data');
    view.setUint32(40, dataLength, true);
    let offset = 44;
    for (let i = 0; i < pcmData.length; i++) {
      view.setInt16(offset, pcmData[i], true);
      offset += bytesPerSample;
    }
    return new Blob([view], { type: 'audio/wav' });
  };

  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await response.json();
    const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
    const mimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

    if (response.ok && audioData && mimeType && mimeType.startsWith("audio/")) {
      const sampleRateMatch = mimeType.match(/rate=(\d+)/);
      const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
      const pcmData = new Int16Array(base64ToArrayBuffer(audioData));
      const wavBlob = pcmToWav(pcmData, sampleRate);
      const audioUrl = URL.createObjectURL(wavBlob);
      const audio = new Audio(audioUrl);
      audio.play();
      audio.onended = () => {
        URL.revokeObjectURL(audioUrl);
        setLoading(false);
      };
    } else {
      console.error("Invalid audio data from API:", result);
      throw new Error("Invalid audio data from API.");
    }
  } catch (error) {
    console.error("TTS API call failed:", error);
    setError('Failed to generate speech.');
    setLoading(false);
  }
};

/**
 * Main application component. Manages state, logic, and rendering.
 */
export default function App() {
  // All available numerology methods for checkboxes
  const allMethods = Object.keys(MAPPINGS).filter(key => !['Vowels', 'Consonants'].includes(key));
  
  // State for Person 1
  const [name1, setName1] = useState('');
  const [dob1, setDob1] = useState('');
  const [tob1, setTob1] = useState('');
  const [location1, setLocation1] = useState('');
  
  // State for Person 2
  const [name2, setName2] = useState('');
  const [dob2, setDob2] = useState('');
  const [tob2, setTob2] = useState('');
  const [location2, setLocation2] = useState('');

  // State for UI and results
  const [selectedMethods, setSelectedMethods] = useState(allMethods);
  const [loading, setLoading] = useState(false);
  const [reportData, setReportData] = useState(null);
  const [error, setError] = useState(null);
  const [isDarkMode, setIsDarkMode] = useState(true);
  const [ttsLoading, setTtsLoading] = useState(false);
  const [ttsError, setTtsError] = useState(null);


  /**
   * Generates all numerology and astrology reports for a single person.
   * @param {object} person - The person's data (name, dob, tob, location).
   * @returns {Promise<object>} An object containing both numerology and astrology results.
   */
  const generateFullReport = async (person) => {
    const numerologyResults = {};
    const numerologyText = [];

    // Calculate all numerology numbers for all selected methods
    selectedMethods.forEach(methodName => {
      const methodologyMapping = MAPPINGS[methodName];
      if (Object.keys(methodologyMapping).length > 0) {
        const destiny = getDestinyNumber(person.name, methodologyMapping);
        const soulUrge = getSoulUrgeNumber(person.name, methodologyMapping);
        const personality = getPersonalityNumber(person.name, methodologyMapping);
        numerologyResults[methodName] = { destiny, soulUrge, personality };
        numerologyText.push(`${methodName} Numerology: Destiny: ${destiny.value}, Soul Urge: ${soulUrge.value}, Personality: ${personality.value}.`);
      }
    });

    const lifePath = getLifePathNumber(person.dob);
    const birthday = getBirthdayNumber(person.dob);
    numerologyResults.lifePath = lifePath;
    numerologyResults.birthday = birthday;
    numerologyText.push(`Life Path: ${lifePath.value}. Birthday: ${birthday.value}.`);

    // Lo Shu grid generation
    const loShuGrids = {};
    const loShuText = [];
    // Base grid from DOB
    loShuGrids.dob = getLoShuChartNumbers(person.dob, null, null);
    loShuText.push('Lo Shu Grid based on Date of Birth.');
    
    // Grids for each selected numerology method (name + dob)
    selectedMethods.forEach(methodName => {
      const methodologyMapping = MAPPINGS[methodName];
      const nameGrid = getLoShuChartNumbers(person.dob, person.name, methodologyMapping);
      loShuGrids[methodName] = nameGrid;
      loShuText.push(`Lo Shu Grid based on ${methodName} Numerology.`);
    });
    
    numerologyResults.loShuGrids = loShuGrids;
    numerologyText.push(loShuText.join(' '));
    
    // Prepend zodiac basics to the astrology report
    const zodiacSign = getZodiacSign(person.dob);
    const zodiacBasicsText = generateZodiacBasics(zodiacSign);
    const astrologyReport = await getAstrologyReport(person);
    const finalAstrologyReport = `${zodiacBasicsText}\n---\n${astrologyReport}`;
    
    return { numerology: numerologyResults, astrology: finalAstrologyReport, text: numerologyText.join(' ') + ' ' + finalAstrologyReport };
  };

  /**
   * Handles the 'Analyze & Compare' button click.
   * Orchestrates all calculations and report generation.
   */
  const handleAnalyze = async () => {
    setLoading(true);
    setReportData(null);
    setError(null);

    const person1Data = { name: name1, dob: dob1, tob: tob1, location: location1 };
    const person2Data = { name: name2, dob: dob2, tob: tob2, location: location2 };
    
    const dateRegex = /^\d{2}[/\-]\d{2}[/\-]\d{4}$/;

    if (!name1 || !dob1) {
      setError('Please enter a name and date of birth for Person 1.');
      setLoading(false);
      return;
    }

    if (!dateRegex.test(dob1)) {
      setError('Invalid Date of Birth format for Person 1. Please use DD/MM/YYYY or DD-MM-YYYY.');
      setLoading(false);
      return;
    }

    let report1 = null;
    let report2 = null;

    try {
      report1 = await generateFullReport(person1Data);
      if (name2 && dob2) {
        if (!dateRegex.test(dob2)) {
          setError('Invalid Date of Birth format for Person 2. Please use DD/MM/YYYY or DD-MM-YYYY.');
          setLoading(false);
          return;
        }
        report2 = await generateFullReport(person2Data);
      }
      setReportData({ person1: report1, person2: report2 });
    } catch (err) {
      console.error(err);
      setError('An error occurred while generating the report.');
    } finally {
      setLoading(false);
    }
  };

  // UI rendering functions
  const renderLoShuChart = (gridData) => {
    const order = [4, 9, 2, 3, 5, 7, 8, 1, 6];
    return (
      <div className="lo-shu-grid grid grid-cols-3 gap-1 w-32 h-32 border-2 border-gray-500 my-2 rounded-lg">
        {order.map(num => (
          <div key={num} className="lo-shu-cell bg-gray-700 flex items-center justify-center font-bold text-lg rounded-md dark:bg-gray-700 dark:text-gray-100 light:bg-gray-200 light:text-gray-800">
            {gridData[num] > 0 ? num.toString().repeat(gridData[num]) : ''}
          </div>
        ))}
      </div>
    );
  };
  
  const renderPersonReport = (personName, report, personId) => {
    if (!report) return null;

    return (
      <div className="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 dark:bg-gray-800 light:bg-white light:border-gray-300">
        <h2 className="text-2xl font-bold mb-4 text-purple-300 dark:text-purple-300 light:text-purple-600 flex items-center">
          <User className="mr-2" /> {personName}
        </h2>
        
        {/* Numerology Section */}
        <div className="mb-8">
          <h3 className="text-xl font-bold mb-4 border-b border-gray-600 pb-2 dark:border-gray-600 light:border-gray-300">Numerology</h3>
          <div className="space-y-4">
            <div className="bg-gray-700 p-4 rounded-xl flex items-center space-x-3 dark:bg-gray-700 light:bg-gray-100">
              <Sparkles className="text-pink-400" size={24} />
              <div>
                <p className="text-sm text-gray-400 font-medium dark:text-gray-400 light:text-gray-500">Life Path Number</p>
                <p className="text-2xl font-extrabold text-pink-300 dark:text-pink-300 light:text-pink-600">{report.numerology.lifePath.value}</p>
                <details className="mt-2 text-sm text-gray-400 cursor-pointer">
                  <summary className="flex items-center text-gray-400">
                    <ChevronDown size={16} className="mr-1 inline-block transition-transform duration-300 group-open:rotate-180" /> Show Calculation
                  </summary>
                  <pre className="mt-2 text-xs p-2 bg-gray-600 rounded-md whitespace-pre-wrap dark:bg-gray-600 light:bg-gray-200">{report.numerology.lifePath.detail}</pre>
                </details>
              </div>
            </div>
            <div className="bg-gray-700 p-4 rounded-xl flex items-center space-x-3 dark:bg-gray-700 light:bg-gray-100">
              <Star className="text-orange-400" size={24} />
              <div>
                <p className="text-sm text-gray-400 font-medium dark:text-gray-400 light:text-gray-500">Birthday Number</p>
                <p className="text-2xl font-extrabold text-orange-300 dark:text-orange-300 light:text-orange-600">{report.numerology.birthday.value}</p>
                <details className="mt-2 text-sm text-gray-400 cursor-pointer">
                  <summary className="flex items-center text-gray-400">
                    <ChevronDown size={16} className="mr-1 inline-block transition-transform duration-300 group-open:rotate-180" /> Show Calculation
                  </summary>
                  <pre className="mt-2 text-xs p-2 bg-gray-600 rounded-md whitespace-pre-wrap dark:bg-gray-600 light:bg-gray-200">{report.numerology.birthday.detail}</pre>
                </details>
              </div>
            </div>
          </div>
          
          {selectedMethods.map((method, index) => (
            <div key={method} className="mt-6 border-t pt-4 border-gray-600 dark:border-gray-600 light:border-gray-300">
              <h4 className="font-bold text-lg mb-2">{method} Numerology</h4>
              <div className="space-y-3">
                {/* Destiny Number */}
                <p>Destiny Number: <span className="font-bold text-indigo-400 dark:text-indigo-400 light:text-indigo-600">{report.numerology[method].destiny.value}</span></p>
                <details className="mt-1 text-sm text-gray-400 cursor-pointer">
                  <summary className="flex items-center text-gray-400">
                    <ChevronDown size={16} className="mr-1 inline-block transition-transform duration-300 group-open:rotate-180" /> Show Calculation
                  </summary>
                  <pre className="mt-2 text-xs p-2 bg-gray-600 rounded-md whitespace-pre-wrap dark:bg-gray-600 light:bg-gray-200">{report.numerology[method].destiny.detail}</pre>
                </details>
                {/* Soul Urge Number */}
                <p>Soul Urge Number: <span className="font-bold text-indigo-400 dark:text-indigo-400 light:text-indigo-600">{report.numerology[method].soulUrge.value}</span></p>
                <details className="mt-1 text-sm text-gray-400 cursor-pointer">
                  <summary className="flex items-center text-gray-400">
                    <ChevronDown size={16} className="mr-1 inline-block transition-transform duration-300 group-open:rotate-180" /> Show Calculation
                  </summary>
                  <pre className="mt-2 text-xs p-2 bg-gray-600 rounded-md whitespace-pre-wrap dark:bg-gray-600 light:bg-gray-200">{report.numerology[method].soulUrge.detail}</pre>
                </details>
                {/* Personality Number */}
                <p>Personality Number: <span className="font-bold text-indigo-400 dark:text-indigo-400 light:text-indigo-600">{report.numerology[method].personality.value}</span></p>
                <details className="mt-1 text-sm text-gray-400 cursor-pointer">
                  <summary className="flex items-center text-gray-400">
                    <ChevronDown size={16} className="mr-1 inline-block transition-transform duration-300 group-open:rotate-180" /> Show Calculation
                  </summary>
                  <pre className="mt-2 text-xs p-2 bg-gray-600 rounded-md whitespace-pre-wrap dark:bg-gray-600 light:bg-gray-200">{report.numerology[method].personality.detail}</pre>
                </details>
              </div>
            </div>
          ))}

          {/* Lo Shu Grid Section */}
          <div className="mt-6 border-t pt-4 border-gray-600 dark:border-gray-600 light:border-gray-300">
            <h4 className="font-bold text-lg mb-2">Lo Shu Grid</h4>
            <div className="flex flex-wrap gap-4 items-start">
              <div className="text-center">
                <p className="text-sm text-gray-400 dark:text-gray-400 light:text-gray-500 mb-1">Based on DOB</p>
                {renderLoShuChart(report.numerology.loShuGrids.dob)}
              </div>
              {selectedMethods.map((method) => (
                <div key={`loshu-${personId}-${method}`} className="text-center">
                  <p className="text-sm text-gray-400 dark:text-gray-400 light:text-gray-500 mb-1">Based on {method}</p>
                  {renderLoShuChart(report.numerology.loShuGrids[method])}
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Astrology Section */}
        <div>
          <h3 className="text-xl font-bold mb-4 border-b border-gray-600 pb-2 dark:border-gray-600 light:border-gray-300">Astrology</h3>
          <div className="prose prose-sm prose-invert dark:prose-invert light:prose max-w-none">
            {report.astrology.split('\n').map((line, index) => (
              <p key={index} className="whitespace-pre-wrap">{line}</p>
            ))}
          </div>
        </div>
      </div>
    );
  };
  
  // Handle checkbox changes for numerology methodologies
  const handleMethodChange = (event) => {
    const { value, checked } = event.target;
    if (value === 'select-all') {
      if (checked) {
        setSelectedMethods(allMethods);
      } else {
        setSelectedMethods([]);
      }
    } else {
      setSelectedMethods(prev =>
        checked ? [...prev, value] : prev.filter(m => m !== value)
      );
    }
  };

  // State to manage a single, combined report text for copy/speak actions
  const [lastCombinedReport, setLastCombinedReport] = useState('');
  useEffect(() => {
    if (reportData) {
      const p1Text = reportData.person1?.text || '';
      const p2Text = reportData.person2?.text ? `\n\n--- Comparison for Person 2 ---\n\n${reportData.person2.text}` : '';
      setLastCombinedReport(p1Text + p2Text);
    }
  }, [reportData]);

  // Handle TTS and Copy actions
  const handleSpeak = () => {
    if (lastCombinedReport) {
      speakTextInThread(lastCombinedReport, setTtsLoading, setTtsError);
    } else {
      setError('No report to speak. Please run an analysis first.');
    }
  };

  const handleCopy = () => {
    if (lastCombinedReport) {
      navigator.clipboard.writeText(lastCombinedReport)
        .then(() => setError('Report copied to clipboard!'))
        .catch(() => setError('Failed to copy.'));
    } else {
      setError('No report to copy. Please run an analysis first.');
    }
  };
  
  // Custom Tailwind classes for input fields to ensure black text contrast
  const inputClassNames = `input-field w-full px-4 py-2 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500
                          ${isDarkMode ? 'bg-gray-700 border-gray-600 text-black placeholder-gray-400' : 'bg-gray-200 border-gray-300 text-black placeholder-gray-500'}`;


  return (
    <div className={`min-h-screen font-['Inter'] transition-colors duration-500 ${isDarkMode ? 'bg-gray-900 text-gray-200' : 'bg-gray-100 text-gray-800'}`}>
      <div className="max-w-7xl mx-auto p-4 sm:p-8">
        <header className="text-center mb-12">
          <h1 className="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-indigo-600 mb-2">
            Numerology & Astrology Nexus
          </h1>
          <p className="text-lg text-gray-400 dark:text-gray-400 light:text-gray-600">
            Simultaneously calculate and compare your life path and cosmic identity.
          </p>
        </header>

        <main className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* Left Panel: Inputs & Controls */}
          <div className="lg:col-span-1 space-y-6">
            <div className={`card dark:bg-gray-800 light:bg-white`}>
              <h2 className={`text-xl font-bold mb-4 dark:text-purple-300 light:text-purple-600`}>Person 1</h2>
              <div className="input-group">
                <label className="block mb-1">Name:</label>
                <input type="text" value={name1} onChange={(e) => setName1(e.target.value)} placeholder="Enter Full Name" className={inputClassNames} />
              </div>
              <div className="input-group">
                <label className="block mb-1">Date of Birth:</label>
                <input type="text" value={dob1} onChange={(e) => setDob1(e.target.value)} placeholder="DD/MM/YYYY or DD-MM-YYYY" className={inputClassNames} />
              </div>
              <div className="input-group">
                <label className="block mb-1">Time of Birth:</label>
                <input type="text" value={tob1} onChange={(e) => setTob1(e.target.value)} placeholder="HH:MM (optional)" className={inputClassNames} />
              </div>
              <div className="input-group">
                <label className="block mb-1">Location of Birth:</label>
                <input type="text" value={location1} onChange={(e) => setLocation1(e.target.value)} placeholder="City, Country (optional)" className={inputClassNames} />
              </div>
            </div>

            <div className={`card dark:bg-gray-800 light:bg-white`}>
              <h2 className={`text-xl font-bold mb-4 dark:text-purple-300 light:text-purple-600`}>Person 2</h2>
              <div className="input-group">
                <label className="block mb-1">Name:</label>
                <input type="text" value={name2} onChange={(e) => setName2(e.target.value)} placeholder="Enter Full Name (Optional)" className={inputClassNames} />
              </div>
              <div className="input-group">
                <label className="block mb-1">Date of Birth:</label>
                <input type="text" value={dob2} onChange={(e) => setDob2(e.target.value)} placeholder="DD/MM/YYYY or DD-MM-YYYY (Optional)" className={inputClassNames} />
              </div>
              <div className="input-group">
                <label className="block mb-1">Time of Birth:</label>
                <input type="text" value={tob2} onChange={(e) => setTob2(e.target.value)} placeholder="HH:MM (optional)" className={inputClassNames} />
              </div>
              <div className="input-group">
                <label className="block mb-1">Location of Birth:</label>
                <input type="text" value={location2} onChange={(e) => setLocation2(e.target.value)} placeholder="City, Country (optional)" className={inputClassNames} />
              </div>
            </div>

            <div className={`card dark:bg-gray-800 light:bg-white`}>
              <h2 className="text-xl font-bold mb-4">Select Numerology Methodologies</h2>
              <div className="space-y-2">
                <div className="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    id="select-all-checkbox"
                    value="select-all"
                    checked={selectedMethods.length === allMethods.length}
                    onChange={handleMethodChange}
                    className="w-4 h-4 text-blue-600 bg-gray-700 rounded border-gray-600 focus:ring-blue-500"
                  />
                  <label htmlFor="select-all-checkbox" className="font-bold cursor-pointer">Select All</label>
                </div>
                {allMethods.map(method => (
                  <div key={method} className="flex items-center space-x-2">
                    <input
                      type="checkbox"
                      id={`method-${method.toLowerCase().replace(/\s/g, '-')}`}
                      value={method}
                      checked={selectedMethods.includes(method)}
                      onChange={handleMethodChange}
                      className="w-4 h-4 text-blue-600 bg-gray-700 rounded border-gray-600 focus:ring-blue-500"
                    />
                    <label htmlFor={`method-${method.toLowerCase().replace(/\s/g, '-')}`} className="cursor-pointer">{method}</label>
                  </div>
                ))}
              </div>
            </div>

            <div className={`card space-y-4 dark:bg-gray-800 light:bg-white`}>
              <h2 className="text-xl font-bold">Actions</h2>
              <button
                onClick={handleAnalyze}
                className="w-full btn btn-primary flex items-center justify-center space-x-2"
                disabled={loading}
              >
                {loading ? (
                  <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                ) : (
                  <>
                    <RefreshCcw size={20} />
                    <span>Analyze & Compare</span>
                  </>
                )}
              </button>
              <div className="grid grid-cols-2 gap-4">
                <button onClick={handleSpeak} className="btn btn-secondary flex items-center justify-center space-x-2" disabled={ttsLoading}>
                  {ttsLoading ? (
                    <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                  ) : (
                    <>
                      <Volume2 size={20} />
                      <span>Speak</span>
                    </>
                  )}
                </button>
                <button onClick={handleCopy} className="btn btn-secondary flex items-center justify-center space-x-2">
                  <Clipboard size={20} />
                  <span>Copy</span>
                </button>
              </div>
              <button onClick={() => setIsDarkMode(!isDarkMode)} className="btn btn-secondary w-full">
                <Palette size={20} className="mr-2"/> Toggle Theme
              </button>
            </div>
            {error && <div className="text-red-500 mt-4 text-center">{error}</div>}
            {ttsError && <div className="text-red-500 mt-4 text-center">{ttsError}</div>}
          </div>

          {/* Right Panel: Results */}
          <div className="lg:col-span-2">
            {loading && !reportData && (
              <div className="flex flex-col items-center justify-center h-full text-center">
                <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <p className="mt-4 text-lg text-gray-400">Analyzing the cosmos... this may take a moment.</p>
              </div>
            )}
            {!loading && !reportData && (
              <div className={`flex items-center justify-center p-8 border-4 border-dashed rounded-2xl border-gray-700 h-96 dark:border-gray-700 light:border-gray-300`}>
                <p className="text-center text-gray-400">Your comprehensive report will appear here after analysis.</p>
              </div>
            )}
            {!loading && reportData && (
              <div className={`grid grid-cols-1 ${reportData.person2 ? 'lg:grid-cols-2' : ''} gap-8`}>
                {renderPersonReport(name1, reportData.person1, 'person1')}
                {reportData.person2 && renderPersonReport(name2, reportData.person2, 'person2')}
              </div>
            )}
          </div>
        </main>
      </div>
    </div>
  );
}
