<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Numerology & Astrology Nexus BY ADV HASSAN RAZA KHAN +923435161290</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .card { @apply p-6 rounded-2xl shadow-lg border transition-colors duration-300; }
        .dark .card { @apply bg-gray-800 border-gray-700; }
        .light .card { @apply bg-white border-black-300; }
        .input-group { @apply mb-4; }
        /* Corrected input field styling as requested */
        .input-field { @apply w-full px-4 py-2 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500 transition-colors duration-300 bg-white text-black font-bold; }
        .btn { @apply font-semibold py-2 px-4 rounded-full shadow-md transition-transform duration-200 active:scale-95; }
        .btn-primary { @apply bg-gradient-to-r from-purple-500 to-indigo-600 text-black hover:from-purple-600 hover:to-indigo-700; }
        .btn-secondary { @apply bg-gray-600 text-white hover:bg-black-700; }
        .dark .btn-secondary { @apply bg-gray-600 text-white hover:bg-black-700; }
        .light .btn-secondary { @apply bg-gray-300 text-black-800 hover:bg-black-400; }
        .prose-sm pre { @apply p-2 rounded-md whitespace-pre-wrap; }
        .dark .prose-sm pre { @apply bg-gray-600 text-black-100; }
        .light .prose-sm pre { @apply bg-gray-200 text-black-800; }
        .report-section { @apply mt-6 border-t pt-4 border-gray-600 dark:border-gray-600 light:border-gray-300; }
        .api-link { @apply block w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold text-center rounded-lg shadow-lg transform transition-transform duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500; }
        .api-validation-btn { @apply w-full py-3 px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-lg transform transition-transform duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500; }
    </style>
</head>
<body class="min-h-screen font-['Inter'] transition-colors duration-500 bg-gray-900 text-red-200">

<div class="max-w-7xl mx-auto p-4 sm:p-8">
    <header class="text-center mb-12">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-indigo-600 mb-2">
            Numerology & Astrology Nexus
        </h1>
        <p class="text-lg text-gray-400">
            Simultaneously calculate and compare your life path and cosmic identity by adv hassan raza khan.
        </p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Panel: Inputs & Controls -->
        <div class="lg:col-span-1 space-y-6">
            <div id="person1-card" class="card">
                <h2 class="text-xl font-bold mb-4 text-purple-300">Person 1</h2>
                <div class="input-group">
                    <label class="block mb-1 text-black-400">Name:</label>
                    <input type="text" id="name1" placeholder="Enter Full Name" class="input-field">
                </div>
                <div class="input-group">
                    <label class="block mb-1 text-black-400">Date of Birth:</label>
                    <input type="text" id="dob1" placeholder="DD/MM/YYYY or DD-MM-YYYY" class="input-field">
                </div>
            </div>

            <div id="person2-card" class="card">
                <h2 class="text-xl font-bold mb-4 text-purple-300">Person 2</h2>
                <div class="input-group">
                    <label class="block mb-1 text-black-400">Name:</label>
                    <input type="text" id="name2" placeholder="Enter Full Name (Optional)" class="input-field">
                </div>
                <div class="input-group">
                    <label class="block mb-1 text-black-400">Date of Birth:</label>
                    <input type="text" id="dob2" placeholder="DD/MM/YYYY or DD-MM-YYYY (Optional)" class="input-field">
                </div>
            </div>

            <div id="methods-card" class="card">
                <h2 class="text-xl font-bold mb-4">Select Numerology Methodologies</h2>
                <div class="space-y-2" id="methodology-checkboxes"></div>
            </div>

            <div class="card space-y-4">
                <h2 class="text-xl font-bold">Actions</h2>
                <button id="analyze-btn" class="w-full btn btn-primary flex items-center justify-center space-x-2">
                    <span id="analyze-icon"></span>
                    <span id="analyze-text">Analyze & Compare</span>
                </button>
                <button id="copy-btn" class="btn btn-secondary flex items-center justify-center space-x-2 w-full">
                    <span id="copy-icon"></span>
                    <span>Copy Report</span>
                </button>
                <button id="theme-btn" class="btn btn-secondary w-full">
                    <span id="theme-icon"></span>
                    <span>Toggle Theme</span>
                </button>
            </div>

            <!-- API Key Section -->
            <div class="card space-y-4" id="api-card" style="display: none;">
                <h2 class="text-xl font-bold mb-2">Let's see what AI says!</h2>
                <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-link">Generate Your API Key</a>
                <div class="text-sm text-gray-400 space-y-2">
                    <p class="font-bold text-gray-300">Instructions to get your API Key:</p>
                    <ol class="list-decimal list-inside">
                        <li>Click on **Generate API Key**.</li>
                        <li>Google AI Studio page will open.</li>
                        <li>Click the blue button **+ Create API Key in new project**.</li>
                        <li>Copy the new API key.</li>
                        <li>Paste it in the box below.</li>
                    </ol>
                </div>
                <div>
                    <input type="password" id="api-key-input" placeholder="Paste your API key here" class="input-field">
                </div>
                <button id="validate-btn" class="api-validation-btn">Validate API Key</button>
                <div id="api-status" class="text-center font-semibold mt-2"></div>
                <button id="ai-report-btn" class="w-full btn btn-primary flex items-center justify-center space-x-2" style="display: none;">
                    <span id="ai-report-text">Get Detailed AI Report</span>
                </button>
            </div>
            
            <div id="error-message" class="text-red-500 mt-4 text-center"></div>
        </div>

        <!-- Right Panel: Results -->
        <div id="results-panel" class="lg:col-span-2 space-y-8">
            <div class="flex items-center justify-center p-8 border-4 border-dashed rounded-2xl border-gray-700 h-96">
                <p class="text-center text-gray-400">Your comprehensive report will appear here after analysis.</p>
            </div>
        </div>
    </main>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Numerology Mappings and Definitions ---
        const MAPPINGS = {
            "Pythagorean": {
                'A': 1, 'J': 1, 'S': 1, 'B': 2, 'K': 2, 'T': 2, 'C': 3, 'L': 3, 'U': 3,
                'D': 4, 'M': 4, 'V': 4, 'E': 5, 'N': 5, 'W': 5, 'F': 6, 'O': 6, 'X': 6,
                'G': 7, 'P': 7, 'Y': 7, 'H': 8, 'Q': 8, 'Z': 8, 'I': 9, 'R': 9
            },
            "Chaldean": {
                'A': 1, 'I': 1, 'J': 1, 'Q': 1, 'Y': 1, 'B': 2, 'K': 2, 'R': 2, 'C': 3, 'G': 3, 'L': 3,
                'S': 3, 'D': 4, 'M': 4, 'T': 4, 'E': 5, 'H': 5, 'N': 5, 'X': 5, 'U': 6, 'V': 6, 'W': 6,
                'O': 7, 'Z': 7, 'F': 8, 'P': 8
            },
            "Cheiro": {
                'A': 1, 'B': 2, 'C': 3, 'D': 4, 'E': 5, 'F': 8, 'G': 3, 'H': 5, 'I': 1, 'J': 1,
                'K': 2, 'L': 3, 'M': 4, 'N': 5, 'O': 7, 'P': 8, 'Q': 1, 'R': 2, 'S': 3,
                'T': 4, 'U': 6, 'V': 6, 'W': 6, 'X': 5, 'Y': 1, 'Z': 7
            },
            "Kabbalistic": {
                'A': 1, 'B': 2, 'C': 3, 'D': 4, 'E': 5, 'F': 6, 'G': 7, 'H': 8, 'I': 9, 'J': 1,
                'K': 2, 'L': 3, 'M': 4, 'N': 5, 'O': 6, 'P': 7, 'Q': 8, 'R': 9, 'S': 1,
                'T': 2, 'U': 3, 'V': 4, 'W': 5, 'X': 6, 'Y': 7, 'Z': 8
            },
            "Islamic (Abjad)": {
                'A': 1, 'B': 2, 'C': 20, 'D': 4, 'E': 5, 'F': 80, 'G': 3, 'H': 5, 'I': 10,
                'J': 3, 'K': 20, 'L': 30, 'M': 40, 'N': 50, 'O': 70, 'P': 80, 'Q': 100,
                'R': 200, 'S': 60, 'T': 400, 'U': 6, 'V': 6, 'W': 6, 'X': 10, 'Y': 10, 'Z': 700
            },
            "Tamil (Vedic)": {
                'A': 1, 'B': 2, 'C': 3, 'D': 4, 'E': 5, 'F': 6, 'G': 7, 'H': 8, 'I': 9, 'J': 1,
                'K': 2, 'L': 3, 'M': 4, 'N': 5, 'O': 6, 'P': 7, 'Q': 8, 'R': 9, 'S': 1,
                'T': 2, 'U': 3, 'V': 4, 'W': 5, 'X': 6, 'Y': 7, 'Z': 8
            },
            "Vowels": ['A', 'E', 'I', 'O', 'U'],
            "Consonants": ['B', 'C', 'D', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'Q', 'R', 'S', 'T', 'V', 'W', 'X', 'Y', 'Z'],
        };
        const MASTER_NUMBERS = new Set([11, 22, 33, 44, 55, 66, 77, 88, 99]);

        // --- Astrology Data (Zodiac Basics) ---
        const ZODIAC_BASICS = {
            "Aries": { luckyNumber: 9, luckyColor: 'Red', element: 'Fire', birthstone: 'Diamond', planet: 'Mars', luckyDay: 'Tuesday' },
            "Taurus": { luckyNumber: 6, luckyColor: 'Green', element: 'Earth', birthstone: 'Emerald', planet: 'Venus', luckyDay: 'Friday' },
            "Gemini": { luckyNumber: 5, luckyColor: 'Yellow', element: 'Air', birthstone: 'Agate', planet: 'Mercury', luckyDay: 'Wednesday' },
            "Cancer": { luckyNumber: 2, luckyColor: 'White', element: 'Water', birthstone: 'Pearl', planet: 'Moon', luckyDay: 'Monday' },
            "Leo": { luckyNumber: 1, luckyColor: 'Gold', element: 'Fire', birthstone: 'Peridot', planet: 'Sun', luckyDay: 'Sunday' },
            "Virgo": { luckyNumber: 5, luckyColor: 'Gray', element: 'Earth', birthstone: 'Sapphire', planet: 'Mercury', luckyDay: 'Wednesday' },
            "Libra": { luckyNumber: 6, luckyColor: 'Pink', element: 'Air', birthstone: 'Opal', planet: 'Venus', luckyDay: 'Friday' },
            "Scorpio": { luckyNumber: 9, luckyColor: 'Black', element: 'Water', birthstone: 'Topaz', planet: 'Pluto', luckyDay: 'Tuesday' },
            "Sagittarius": { luckyNumber: 3, luckyColor: 'Purple', element: 'Fire', birthstone: 'Turquoise', planet: 'Jupiter', luckyDay: 'Thursday' },
            "Capricorn": { luckyNumber: 8, luckyColor: 'Brown', element: 'Earth', birthstone: 'Garnet', planet: 'Saturn', luckyDay: 'Saturday' },
            "Aquarius": { luckyNumber: 4, luckyColor: 'Blue', element: 'Air', birthstone: 'Amethyst', planet: 'Uranus', luckyDay: 'Saturday' },
            "Pisces": { luckyNumber: 7, luckyColor: 'Sea Green', element: 'Water', birthstone: 'Aquamarine', planet: 'Neptune', luckyDay: 'Thursday' },
        };
        const ZODIAC_TRAITS = {
            "Aries": "Aries is a Fire sign, known for being energetic, passionate, and a natural leader. They are often courageous and impulsive.",
            "Taurus": "Taurus is an Earth sign, characterized by their grounded, reliable, and patient nature. They appreciate comfort and stability.",
            "Gemini": "Gemini is an Air sign, known for their curiosity, adaptability, and witty communication skills. They can be a bit indecisive.",
            "Cancer": "Cancer is a Water sign, deeply emotional, intuitive, and nurturing. They are family-oriented and protective of loved ones.",
            "Leo": "Leo is a Fire sign, with a confident, generous, and charismatic personality. They love being in the spotlight and are fiercely loyal.",
            "Virgo": "Virgo is an Earth sign, highly analytical, practical, and detail-oriented. They are often perfectionists and enjoy being of service.",
            "Libra": "Libra is an Air sign, known for their love of balance, justice, and harmony. They are social, diplomatic, and seek partnership.",
            "Scorpio": "Scorpio is a Water sign, intensely passionate, mysterious, and determined. They are known for their emotional depth and powerful presence.",
            "Sagittarius": "Sagittarius is a Fire sign, adventurous, optimistic, and philosophical. They have a love for freedom and exploration.",
            "Capricorn": "Capricorn is an Earth sign, ambitious, disciplined, and responsible. They are focused on long-term goals and success.",
            "Aquarius": "Aquarius is an Air sign, innovative, independent, and humanitarian. They are often visionaries and value their freedom.",
            "Pisces": "Pisces is a Water sign, compassionate, artistic, and dreamy. They are highly intuitive and empathetic to others' feelings.",
        };
        
        // --- DOM Elements ---
        const name1Input = document.getElementById('name1');
        const dob1Input = document.getElementById('dob1');
        const name2Input = document.getElementById('name2');
        const dob2Input = document.getElementById('dob2');
        const analyzeBtn = document.getElementById('analyze-btn');
        const copyBtn = document.getElementById('copy-btn');
        const themeBtn = document.getElementById('theme-btn');
        const resultsPanel = document.getElementById('results-panel');
        const errorMessage = document.getElementById('error-message');
        const methodologyCheckboxesContainer = document.getElementById('methodology-checkboxes');
        const apiCard = document.getElementById('api-card');
        const apiKeyInput = document.getElementById('api-key-input');
        const validateBtn = document.getElementById('validate-btn');
        const aiReportBtn = document.getElementById('ai-report-btn');
        const apiStatus = document.getElementById('api-status');
        
        // --- State ---
        let selectedMethods = [];
        let isDarkMode = true;
        let lastReportData = null;
        let isApiValidated = false;
        let apiKey = "";
        const allMethods = Object.keys(MAPPINGS).filter(key => !['Vowels', 'Consonants'].includes(key));
        
        // --- Utility Functions ---
        const setLoading = (isLoading) => {
            analyzeBtn.disabled = isLoading;
            const icon = document.getElementById('analyze-icon');
            const text = document.getElementById('analyze-text');
            if (isLoading) {
                icon.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>`;
                text.textContent = 'Analyzing...';
            } else {
                icon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-ccw"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.79 2.91L3 8m0 0 4-4m-4 4 4 4"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.79-2.91L21 16m0 0-4 4m4-4-4-4"/></svg>`;
                text.textContent = 'Analyze & Compare';
            }
        };

        const setErrorMessage = (msg) => {
            errorMessage.textContent = msg;
            setTimeout(() => errorMessage.textContent = '', 5000);
        };

        const getIconSvg = (name, className = "") => {
            const icons = {
                RefreshCcw: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-ccw"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.79 2.91L3 8m0 0 4-4m-4 4 4 4"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.79-2.91L21 16m0 0-4 4m4-4-4-4"/></svg>`,
                Clipboard: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>`,
                Palette: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-palette"><circle cx="13.5" cy="6.5" r=".5"/><circle cx="17.5" cy="10.5" r=".5"/><circle cx="17.5" cy="14.5" r=".5"/><circle cx="10.5" cy="10.5" r=".5"/><circle cx="8.5" cy="14.5" r=".5"/><path d="M12 2A10 10 0 0 0 5 20a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1 10 10 0 0 0-5-18"/><path d="M12 2v16"/><path d="M12 2H8.5a5.5 5.5 0 0 0-3 10.5"/><path d="M12 2h3.5a5.5 5.5 0 0 1 0 11"/></svg>`,
                User: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
                Sparkles: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>`,
                Star: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
                ChevronDown: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>`,
                Calendar: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-days"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>`,
            };
            return icons[name] ? `<span class="${className}">${icons[name]}</span>` : '';
        };

        const renderLoShuChart = (gridData) => {
            const order = [4, 9, 2, 3, 5, 7, 8, 1, 6];
            let html = `<div class="lo-shu-grid grid grid-cols-3 gap-1 w-32 h-32 border-2 border-gray-500 my-2 rounded-lg">`;
            order.forEach(num => {
                const content = gridData[num] > 0 ? num.toString().repeat(gridData[num]) : '';
                html += `<div class="lo-shu-cell bg-gray-700 flex items-center justify-center font-bold text-lg rounded-md dark:bg-gray-700 dark:text-gray-100 light:bg-gray-200 light:text-gray-800">${content}</div>`;
            });
            html += `</div>`;
            return html;
        };
        
        const renderPersonReport = (personName, report) => {
            if (!report) return '';

            let html = `
            <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 dark:bg-gray-800 light:bg-white light:border-gray-300">
                <h2 class="text-2xl font-bold mb-4 text-purple-300 dark:text-purple-300 light:text-purple-600 flex items-center">
                    ${getIconSvg('User', 'mr-2')} ${personName}
                </h2>
                
                <!-- Numerology Section -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2 dark:border-gray-600 light:border-gray-300">Numerology</h3>
                    <div class="space-y-4">
                        <div class="bg-gray-700 p-4 rounded-xl flex items-center space-x-3 dark:bg-gray-700 light:bg-gray-100">
                            ${getIconSvg('Sparkles', 'text-pink-400')}
                            <div>
                                <p class="text-sm text-gray-400 font-medium dark:text-gray-400 light:text-gray-500">Life Path Number</p>
                                <p class="text-2xl font-extrabold text-pink-300 dark:text-pink-300 light:text-pink-600">${report.numerology.lifePath.value}</p>
                                <details class="mt-2 text-sm text-gray-400 cursor-pointer">
                                    <summary class="flex items-center text-gray-400">
                                        ${getIconSvg('ChevronDown', 'mr-1 inline-block transition-transform duration-300 group-open:rotate-180')} Show Calculation
                                    </summary>
                                    <pre class="mt-2 text-xs p-2 bg-gray-600 rounded-md whitespace-pre-wrap dark:bg-gray-600 light:bg-gray-200">${report.numerology.lifePath.detail}</pre>
                                </details>
                            </div>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-xl flex items-center space-x-3 dark:bg-gray-700 light:bg-gray-100">
                            ${getIconSvg('Calendar', 'text-orange-400')}
                            <div>
                                <p class="text-sm text-gray-400 font-medium dark:text-gray-400 light:text-gray-500">Birthday Number</p>
                                <p class="text-2xl font-extrabold text-orange-300 dark:text-orange-300 light:text-orange-600">${report.numerology.birthday.value}</p>
                                <details class="mt-2 text-sm text-gray-400 cursor-pointer">
                                    <summary class="flex items-center text-gray-400">
                                        ${getIconSvg('ChevronDown', 'mr-1 inline-block transition-transform duration-300 group-open:rotate-180')} Show Calculation
                                    </summary>
                                    <pre class="mt-2 text-xs p-2 bg-gray-600 rounded-md whitespace-pre-wrap dark:bg-gray-600 light:bg-gray-200">${report.numerology.birthday.detail}</pre>
                                </details>
                            </div>
                        </div>
                    </div>`;

            selectedMethods.forEach(method => {
                html += `
                <div class="report-section">
                    <h4 class="font-bold text-lg mb-2">${method} Numerology</h4>
                    <div class="space-y-3">
                        <p>Destiny Number: <span class="font-bold text-indigo-400 dark:text-indigo-400 light:text-indigo-600">${report.numerology[method].destiny.value}</span></p>
                        <details class="mt-1 text-sm text-gray-400 cursor-pointer">
                            <summary class="flex items-center text-gray-400">
                                ${getIconSvg('ChevronDown', 'mr-1 inline-block transition-transform duration-300 group-open:rotate-180')} Show Calculation
                            </summary>
                            <pre class="mt-2 text-xs p-2 bg-gray-600 rounded-md whitespace-pre-wrap dark:bg-gray-600 light:bg-gray-200">${report.numerology[method].destiny.detail}</pre>
                        </details>
                        <p>Soul Urge Number: <span class="font-bold text-indigo-400 dark:text-indigo-400 light:text-indigo-600">${report.numerology[method].soulUrge.value}</span></p>
                        <details class="mt-1 text-sm text-gray-400 cursor-pointer">
                            <summary class="flex items-center text-gray-400">
                                ${getIconSvg('ChevronDown', 'mr-1 inline-block transition-transform duration-300 group-open:rotate-180')} Show Calculation
                            </summary>
                            <pre class="mt-2 text-xs p-2 bg-gray-600 rounded-md whitespace-pre-wrap dark:bg-gray-600 light:bg-gray-200">${report.numerology[method].soulUrge.detail}</pre>
                        </details>
                        <p>Personality Number: <span class="font-bold text-indigo-400 dark:text-indigo-400 light:text-indigo-600">${report.numerology[method].personality.value}</span></p>
                        <details class="mt-1 text-sm text-gray-400 cursor-pointer">
                            <summary class="flex items-center text-gray-400">
                                ${getIconSvg('ChevronDown', 'mr-1 inline-block transition-transform duration-300 group-open:rotate-180')} Show Calculation
                            </summary>
                            <pre class="mt-2 text-xs p-2 bg-gray-600 rounded-md whitespace-pre-wrap dark:bg-gray-600 light:bg-gray-200">${report.numerology[method].personality.detail}</pre>
                        </details>
                    </div>
                </div>`;
            });
            
            html += `
                    <!-- Lo Shu Grid Section -->
                    <div class="report-section">
                        <h4 class="font-bold text-lg mb-2">Lo Shu Grid</h4>
                        <div class="flex flex-wrap gap-4 items-start">
                            <div class="text-center">
                                <p class="text-sm text-gray-400 dark:text-gray-400 light:text-gray-500 mb-1">Based on DOB</p>
                                ${renderLoShuChart(report.numerology.loShuGrids.dob)}
                            </div>
            `;
            selectedMethods.forEach(method => {
                html += `
                            <div class="text-center">
                                <p class="text-sm text-gray-400 dark:text-gray-400 light:text-gray-500 mb-1">Based on ${method}</p>
                                ${renderLoShuChart(report.numerology.loShuGrids[method])}
                            </div>
                `;
            });
            html += `
                        </div>
                    </div>
                </div>
                <!-- Astrology Section -->
                <div class="report-section">
                    <h3 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2 dark:border-gray-600 light:border-gray-300">Astrology</h3>
                    <div class="prose prose-sm prose-invert dark:prose-invert light:prose max-w-none">
                        <p>${report.astrology.replace(/\n/g, '</p><p>')}</p>
                    </div>
                </div>
            </div>`;

            return html;
        };
        
        const updateResultsPanel = (reportData) => {
            resultsPanel.innerHTML = ''; // Clear previous content
            if (reportData.person1) {
                const p1Html = renderPersonReport('Person 1', reportData.person1);
                resultsPanel.innerHTML += `<div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 dark:bg-gray-800 light:bg-white light:border-gray-300">${p1Html}</div>`;
            }
            if (reportData.person2) {
                const p2Html = renderPersonReport('Person 2', reportData.person2);
                resultsPanel.innerHTML += `<div class="mt-8 bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 dark:bg-gray-800 light:bg-white light:border-gray-300">${p2Html}</div>`;
            }
        };

        const renderCheckboxes = () => {
            methodologyCheckboxesContainer.innerHTML = `
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="select-all-checkbox" value="select-all" checked class="w-4 h-4 text-blue-600 bg-gray-700 rounded border-gray-600 focus:ring-blue-500 cursor-pointer">
                    <label for="select-all-checkbox" class="font-bold cursor-pointer">Select All</label>
                </div>
            `;
            allMethods.forEach(method => {
                const methodId = `method-${method.toLowerCase().replace(/\s/g, '-')}`;
                methodologyCheckboxesContainer.innerHTML += `
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="${methodId}" value="${method}" checked class="w-4 h-4 text-blue-600 bg-gray-700 rounded border-gray-600 focus:ring-blue-500 cursor-pointer">
                        <label for="${methodId}" class="cursor-pointer">${method}</label>
                    </div>
                `;
            });
            selectedMethods = [...allMethods];
        };

        // --- Core Numerology Functions ---
        const reduceNumber = (num) => {
            if (MASTER_NUMBERS.has(num)) return num;
            let sum = num;
            while (sum > 9 && !MASTER_NUMBERS.has(sum)) {
                sum = String(sum).split('').reduce((acc, digit) => acc + parseInt(digit, 10), 0);
            }
            return sum;
        };

        const getDestinyNumber = (name, methodology) => {
            let total = 0;
            const sanitizedName = name.replace(/[^a-zA-Z]/g, '').toUpperCase();
            const detail = `Full Name letters and their values:\n${sanitizedName.split('').map(char => `${char}=${methodology[char] || 0}`).join(' + ')}`;
            total = sanitizedName.split('').reduce((sum, char) => sum + (methodology[char] || 0), 0);
            const finalNumber = reduceNumber(total);
            return { value: finalNumber, detail: `${detail} = ${total}.\nReduction: ${total} -> ${finalNumber}.` };
        };

        const getSoulUrgeNumber = (name, methodology) => {
            let total = 0;
            const sanitizedName = name.replace(/[^a-zA-Z]/g, '').toUpperCase();
            const vowels = sanitizedName.split('').filter(char => MAPPINGS.Vowels.includes(char));
            const detail = `Vowels and their values:\n${vowels.map(char => `${char}=${methodology[char] || 0}`).join(' + ')}`;
            total = vowels.reduce((sum, char) => sum + (methodology[char] || 0), 0);
            const finalNumber = reduceNumber(total);
            return { value: finalNumber, detail: `${detail} = ${total}.\nReduction: ${total} -> ${finalNumber}.` };
        };

        const getPersonalityNumber = (name, methodology) => {
            let total = 0;
            const sanitizedName = name.replace(/[^a-zA-Z]/g, '').toUpperCase();
            const consonants = sanitizedName.split('').filter(char => MAPPINGS.Consonants.includes(char));
            const detail = `Consonants and their values:\n${consonants.map(char => `${char}=${methodology[char] || 0}`).join(' + ')}`;
            total = consonants.reduce((sum, char) => sum + (methodology[char] || 0), 0);
            const finalNumber = reduceNumber(total);
            return { value: finalNumber, detail: `${detail} = ${total}.\nReduction: ${total} -> ${finalNumber}.` };
        };

        const getBirthdayNumber = (dob) => {
            const normalizedDob = dob.replace(/-/g, '/');
            const dobDay = parseInt(normalizedDob.split('/')[0], 10);
            if (isNaN(dobDay)) return { value: 'N/A', detail: 'Invalid Date of Birth format.' };
            const finalNumber = reduceNumber(dobDay);
            const detail = `Day of birth is ${dobDay}.\nReduction: ${dobDay} -> ${finalNumber}`;
            return { value: finalNumber, detail };
        };

        const getLifePathNumber = (dob) => {
            const normalizedDob = dob.replace(/-/g, '/');
            const [day, month, year] = normalizedDob.split('/').map(Number);
            const reducedYear = reduceNumber(year);
            const reducedMonth = reduceNumber(month);
            const reducedDay = reduceNumber(day);
            const sum = reducedYear + reducedMonth + reducedDay;
            const finalNumber = reduceNumber(sum);
            const detail = `Year (${year}) -> ${reducedYear}\nMonth (${month}) -> ${reducedMonth}\nDay (${day}) -> ${reducedDay}\nSum: ${reducedYear} + ${reducedMonth} + ${reducedDay} = ${sum}.\nReduction: ${sum} -> ${finalNumber}.`;
            return { value: finalNumber, detail };
        };

        const getLoShuChartNumbers = (dob, name, methodology) => {
            let allDigits = [];
            const dobDigits = dob.replace(/[\/\-]/g, '').split('').filter(d => d !== '0');
            allDigits = allDigits.concat(dobDigits.map(Number));
            if (name && methodology) {
                const sanitizedName = name.replace(/[^a-zA-Z]/g, '').toUpperCase();
                const nameNumbers = sanitizedName.split('').map(char => methodology[char] || 0).filter(n => n > 0);
                allDigits = allDigits.concat(nameNumbers);
            }
            const grid = { '4': 0, '9': 0, '2': 0, '3': 0, '5': 0, '7': 0, '8': 0, '1': 0, '6': 0 };
            allDigits.forEach(num => {
                if (grid.hasOwnProperty(num.toString())) {
                    grid[num.toString()] += 1;
                }
            });
            return grid;
        };

        // --- Astrology Calculation (same as standalone code) ---
        const getZodiacSign = (dob) => {
            const normalizedDob = dob.replace(/-/g, '/');
            const [day, month] = normalizedDob.split('/').map(Number);
            if (isNaN(day) || isNaN(month) || month < 1 || month > 12) return null;
            if ((month === 1 && day >= 20) || (month === 2 && day <= 18)) return "Aquarius";
            if ((month === 2 && day >= 19) || (month === 3 && day <= 20)) return "Pisces";
            if ((month === 3 && day >= 21) || (month === 4 && day <= 19)) return "Aries";
            if ((month === 4 && day >= 20) || (month === 5 && day <= 20)) return "Taurus";
            if ((month === 5 && day >= 21) || (month === 6 && day <= 20)) return "Gemini";
            if ((month === 6 && day >= 21) || (month === 7 && day <= 22)) return "Cancer";
            if ((month === 7 && day >= 23) || (month === 8 && day <= 22)) return "Leo";
            if ((month === 8 && day >= 23) || (month === 9 && day <= 22)) return "Virgo";
            if ((month === 9 && day >= 23) || (month === 10 && day <= 22)) return "Libra";
            if ((month === 10 && day >= 23) || (month === 11 && day <= 21)) return "Scorpio";
            if ((month === 11 && day >= 22) || (month === 12 && day <= 21)) return "Sagittarius";
            if ((month === 12 && day >= 22) || (month === 1 && day <= 19)) return "Capricorn";
            return null;
        };
        
        const generateAstrologyReport = (dob) => {
            const zodiacSign = getZodiacSign(dob);
            if (!zodiacSign) {
                return "Could not determine Zodiac Sign from the provided date.";
            }
            
            const basics = ZODIAC_BASICS[zodiacSign];
            const traits = ZODIAC_TRAITS[zodiacSign];
            
            let report = `### Your Zodiac Identity\n\n`;
            report += `Based on your date of birth, your Zodiac Sign is **${zodiacSign}**.\n\n`;
            report += `**General Traits:**\n${traits}\n\n`;
            
            if (basics) {
                report += `**Key Astrological Information:**\n`;
                report += `* Lucky Number: **${basics.luckyNumber}**\n`;
                report += `* Lucky Color: **${basics.luckyColor}**\n`;
                report += `* Favorable Element: **${basics.element}**\n`;
                report += `* Birthstone: **${basics.birthstone}**\n`;
                report += `* Ruling Planet: **${basics.planet}**\n`;
                report += `* Lucky Day: **${basics.luckyDay}**\n`;
            }
            return report;
        };

        // --- Event Listeners and Main Logic ---
        document.getElementById('analyze-btn').addEventListener('click', async () => {
            setErrorMessage('');
            const name1 = name1Input.value.trim();
            const dob1 = dob1Input.value.trim();
            const name2 = name2Input.value.trim();
            const dob2 = dob2Input.value.trim();
            const dateRegex = /^\d{2}[/\-]\d{2}[/\-]\d{4}$/;

            if (!name1 || !dob1) {
                setErrorMessage('Please enter a name and date of birth for Person 1.');
                return;
            }
            if (!dateRegex.test(dob1)) {
                setErrorMessage('Invalid Date of Birth format for Person 1. Please use DD/MM/YYYY or DD-MM-YYYY.');
                return;
            }
            if (name2 && dob2 && !dateRegex.test(dob2)) {
                setErrorMessage('Invalid Date of Birth format for Person 2. Please use DD/MM/YYYY or DD-MM-YYYY.');
                return;
            }

            setLoading(true);
            
            let report1 = {};
            let report2 = null;

            try {
                // Generate report for Person 1
                const numerology1 = {};
                selectedMethods.forEach(method => {
                    const methodology = MAPPINGS[method];
                    numerology1[method] = {
                        destiny: getDestinyNumber(name1, methodology),
                        soulUrge: getSoulUrgeNumber(name1, methodology),
                        personality: getPersonalityNumber(name1, methodology)
                    };
                });
                numerology1.lifePath = getLifePathNumber(dob1);
                numerology1.birthday = getBirthdayNumber(dob1);
                const loShuGrids1 = {};
                loShuGrids1.dob = getLoShuChartNumbers(dob1, null, null);
                selectedMethods.forEach(method => {
                    loShuGrids1[method] = getLoShuChartNumbers(dob1, name1, MAPPINGS[method]);
                });
                numerology1.loShuGrids = loShuGrids1;
                const astrology1 = generateAstrologyReport(dob1);
                report1 = { numerology: numerology1, astrology: astrology1, name: name1, dob: dob1 };
                
                // Generate report for Person 2 if data is present
                if (name2 && dob2) {
                    const numerology2 = {};
                    selectedMethods.forEach(method => {
                        const methodology = MAPPINGS[method];
                        numerology2[method] = {
                            destiny: getDestinyNumber(name2, methodology),
                            soulUrge: getSoulUrgeNumber(name2, methodology),
                            personality: getPersonalityNumber(name2, methodology)
                        };
                    });
                    numerology2.lifePath = getLifePathNumber(dob2);
                    numerology2.birthday = getBirthdayNumber(dob2);
                    const loShuGrids2 = {};
                    loShuGrids2.dob = getLoShuChartNumbers(dob2, null, null);
                    selectedMethods.forEach(method => {
                        loShuGrids2[method] = getLoShuChartNumbers(dob2, name2, MAPPINGS[method]);
                    });
                    numerology2.loShuGrids = loShuGrids2;
                    const astrology2 = generateAstrologyReport(dob2);
                    report2 = { numerology: numerology2, astrology: astrology2, name: name2, dob: dob2 };
                }
                
                lastReportData = { person1: report1, person2: report2 };
                updateResultsPanel(lastReportData);
                apiCard.style.display = 'block';

            } catch (err) {
                console.error(err);
                setErrorMessage('An unexpected error occurred. Please try again.');
            } finally {
                setLoading(false);
            }
        });

        document.getElementById('copy-btn').addEventListener('click', () => {
            if (lastReportData) {
                let combinedReport = "";
                // Generate plain text report from structured data
                if (lastReportData.person1) {
                    combinedReport += `Person 1 Report\n\n`;
                    combinedReport += `Name: ${lastReportData.person1.name}\n`;
                    combinedReport += `Date of Birth: ${lastReportData.person1.dob}\n\n`;
                    combinedReport += `--- Numerology ---\n`;
                    combinedReport += `Life Path Number: ${lastReportData.person1.numerology.lifePath.value}\n`;
                    combinedReport += `Birthday Number: ${lastReportData.person1.numerology.birthday.value}\n\n`;
                    combinedReport += `--- Astrology ---\n`;
                    combinedReport += lastReportData.person1.astrology.replace(/<[^>]*>?/gm, '').replace(/\n/g, '\n');
                }
                if (lastReportData.person2) {
                    combinedReport += `\n\n--- Person 2 Report ---\n\n`;
                    combinedReport += `Name: ${lastReportData.person2.name}\n`;
                    combinedReport += `Date of Birth: ${lastReportData.person2.dob}\n\n`;
                    combinedReport += `--- Numerology ---\n`;
                    combinedReport += `Life Path Number: ${lastReportData.person2.numerology.lifePath.value}\n`;
                    combinedReport += `Birthday Number: ${lastReportData.person2.numerology.birthday.value}\n\n`;
                    combinedReport += `--- Astrology ---\n`;
                    combinedReport += lastReportData.person2.astrology.replace(/<[^>]*>?/gm, '').replace(/\n/g, '\n');
                }

                try {
                    const tempInput = document.createElement('textarea');
                    document.body.appendChild(tempInput);
                    tempInput.value = combinedReport;
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    setErrorMessage('Report copied to clipboard!');
                } catch (err) {
                    setErrorMessage('Failed to copy.');
                }
            } else {
                setErrorMessage('No report to copy. Please run an analysis first.');
            }
        });

        document.getElementById('theme-btn').addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.body.classList.add('bg-gray-900', 'text-gray-200');
                document.body.classList.remove('bg-gray-100', 'text-gray-800');
            } else {
                document.body.classList.add('bg-gray-100', 'text-gray-800');
                document.body.classList.remove('bg-gray-900', 'text-gray-200');
            }
        });

        document.getElementById('methodology-checkboxes').addEventListener('change', (event) => {
            const { value, checked } = event.target;
            if (value === 'select-all') {
                document.querySelectorAll('#methodology-checkboxes input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = checked;
                });
                selectedMethods = checked ? [...allMethods] : [];
            } else {
                if (checked) {
                    selectedMethods.push(value);
                } else {
                    selectedMethods = selectedMethods.filter(m => m !== value);
                }
                const allChecked = allMethods.every(method => selectedMethods.includes(method));
                document.getElementById('select-all-checkbox').checked = allChecked;
            }
        });

        validateBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key) {
                isApiValidated = true;
                apiKey = key;
                apiStatus.textContent = 'API Key Validated!';
                apiStatus.classList.remove('text-red-400');
                apiStatus.classList.add('text-green-400');
                aiReportBtn.style.display = 'block';
            } else {
                isApiValidated = false;
                apiStatus.textContent = 'Invalid API Key. Please try again.';
                apiStatus.classList.remove('text-green-400');
                apiStatus.classList.add('text-red-400');
                aiReportBtn.style.display = 'none';
            }
        });

        aiReportBtn.addEventListener('click', async () => {
            if (!isApiValidated || !lastReportData) {
                setErrorMessage('Please validate your API key and generate the basic report first.');
                return;
            }

            aiReportBtn.disabled = true;
            aiReportBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Generating...`;

            let prompt = `You are an expert astrologer and numerologist. Provide a detailed, organized, and comprehensive analysis based on the following information. Use headings, paragraphs, and bullet points for easy reading. Do not mention that this is an AI-generated response.`;

            // Prepare the data to be sent to the model
            const person1Zodiac = getZodiacSign(lastReportData.person1.dob);
            prompt += `\n\n**Person 1:**\n- Name: ${lastReportData.person1.name}\n- Date of Birth: ${lastReportData.person1.dob}\n- Life Path Number: ${lastReportData.person1.numerology.lifePath.value}\n- Zodiac Sign: ${person1Zodiac}\n`;
            
            if (lastReportData.person2) {
                const person2Zodiac = getZodiacSign(lastReportData.person2.dob);
                prompt += `\n**Person 2:**\n- Name: ${lastReportData.person2.name}\n- Date of Birth: ${lastReportData.person2.dob}\n- Life Path Number: ${lastReportData.person2.numerology.lifePath.value}\n- Zodiac Sign: ${person2Zodiac}\n\n`;
                prompt += `Please provide a detailed comparison and compatibility analysis between Person 1 and Person 2, covering numerology and astrology.`;
            } else {
                prompt += `\n\nProvide a detailed personal analysis based on this information.`
            }

            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }]
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API response error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const detailedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (detailedText) {
                    const aiReportHtml = `<div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 mt-8 dark:bg-gray-800 light:bg-white light:border-gray-300">
                                            <h3 class="text-xl font-bold mb-4">Detailed AI Report</h3>
                                            <div class="prose prose-sm prose-invert dark:prose-invert light:prose max-w-none">
                                                ${detailedText.replace(/\n/g, '<br/>')}
                                            </div>
                                          </div>`;
                    resultsPanel.innerHTML += aiReportHtml;
                } else {
                    setErrorMessage("Could not generate a detailed report. The API may have returned an empty or invalid response.");
                }
            } catch (err) {
                console.error('API Error:', err);
                setErrorMessage("An error occurred while generating the detailed report. Please ensure your API key is correct and try again.");
            } finally {
                aiReportBtn.disabled = false;
                aiReportBtn.innerHTML = 'Get Detailed AI Report';
            }
        });

        // Initial setup
        renderCheckboxes();
        document.getElementById('analyze-icon').innerHTML = getIconSvg('RefreshCcw');
        document.getElementById('copy-icon').innerHTML = getIconSvg('Clipboard');
        document.getElementById('theme-icon').innerHTML = getIconSvg('Palette');
    });
</script>

</body>
</html>
